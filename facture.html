<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Facture - ONBL</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background:#f9f9f9; font-family: Arial, sans-serif; }
    .container { max-width:900px; margin-top:30px; }
    .invoice-box { background:#fff; padding:20px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
  </style>
</head>
<body>
<div class="container">
  <div class="invoice-box">
    <div class="text-center mb-3">
      <img src="assets/logo_fr.png" alt="logo" style="height:60px;"><h2>Facture</h2>
    </div>

    <div class="row mb-2">
      <div class="col-md-6">
        <label>Code client (si non rempli automatiquement) :</label>
        <input id="clientCodeInput" class="form-control" placeholder="Entrez code client">
      </div>
      <div class="col-md-6 text-end">
        <p><strong>Numéro de commande :</strong> <span id="order-id">—</span></p>
        <p><strong>Date :</strong> <span id="order-date">—</span></p>
      </div>
    </div>

    <table class="table table-striped" id="invoice-table">
      <thead class="table-dark">
        <tr><th>Article</th><th class="text-center">Quantité</th><th class="text-end">Prix unitaire</th><th class="text-end">Total</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr><td colspan="3" class="text-end">Sous-total</td><td class="text-end"><span id="subtotal-val">0.00</span> $</td></tr>
        <tr><td colspan="3" class="text-end">Livraison</td><td class="text-end"><span id="delivery-val">0.00</span> $</td></tr>
        <tr class="table-active"><td colspan="3" class="text-end"><strong>Total</strong></td><td class="text-end"><strong><span id="total-val">0.00</span> $</strong></td></tr>
      </tfoot>
    </table>

    <div class="mb-3">
      <label for="payment-method"><strong>Mode de paiement :</strong></label>
      <select id="payment-method" class="form-select" style="max-width:320px;">
        <option value="magasin">Au magasin</option>
        <option value="livraison">À la livraison</option>
        <option value="enligne">En ligne (si disponible)</option>
      </select>
      <small class="form-text text-muted" id="payment-note">Vérification disponibilité paiement en ligne...</small>
    </div>

    <div class="mb-3">
      <button id="btn-download" class="btn btn-success"><i class="fa fa-file-pdf"></i> Télécharger en PDF</button>
      <button id="btn-clear" class="btn btn-warning">Vider le panier</button>
      <button id="btn-call" class="btn btn-info">Appeler: 514-123-4567</button>
    </div>

    <div class="mt-4 text-muted">
      <p><strong>Instructions de paiement :</strong></p>
      <ul>
        <li>Paiement en ligne: Visa, Mastercard, Débit (si activé).</li>
        <li>Si pas de paiement en ligne, paierez au magasin ou à la livraison.</li>
        <li>Livraison gratuite pour commande > 20$.</li>
      </ul>
    </div>
  </div>
</div>

<!-- jsPDF + autoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- central cart logic -->
<script src="cart.js"></script>

<script>
  // Helper: get active client code (input overrides stored)
  function getActiveClientCode() {
    const input = document.getElementById('clientCodeInput');
    const stored = localStorage.getItem('clientCode_current') || '';
    const val = (input && input.value.trim()) ? input.value.trim() : stored;
    if (input && !input.value && stored) input.value = stored;
    return val || '';
  }

  function renderInvoice() {
    const client = getActiveClientCode();
    if (!client) {
      // clear table
      document.querySelector('#invoice-table tbody').innerHTML = '';
      document.getElementById('subtotal-val').textContent = '0.00';
      document.getElementById('delivery-val').textContent = '0.00';
      document.getElementById('total-val').textContent = '0.00';
      return;
    }
    // use CartAPI to build invoice
    const invoiceData = window.CartAPI.generateInvoiceHTML(client, document.getElementById('payment-method').value);
    if (!invoiceData) {
      renderEmpty();
      return;
    }
    // we have invoiceData.html (full HTML); but to populate fields we re-calc quickly
    const cart = window.CartAPI.loadCart(client);
    const tbody = document.querySelector('#invoice-table tbody');
    tbody.innerHTML = '';
    let subtotal = 0;
    cart.forEach(it => {
      const tr = document.createElement('tr');
      const line = it.price * it.quantity;
      subtotal += line;
      tr.innerHTML = `<td>${it.name}</td><td class="text-center">${it.quantity}</td><td class="text-end">${it.price.toFixed(2)} $</td><td class="text-end">${line.toFixed(2)} $</td>`;
      tbody.appendChild(tr);
    });
    const delivery = subtotal > 20 ? 0 : 5;
    const total = subtotal + delivery;
    document.getElementById('subtotal-val').textContent = subtotal.toFixed(2);
    document.getElementById('delivery-val').textContent = delivery.toFixed(2);
    document.getElementById('total-val').textContent = total.toFixed(2);

    // fill order id + date
    const orderId = 'CMD-' + Date.now();
    document.getElementById('order-id').textContent = orderId;
    document.getElementById('order-date').textContent = new Date().toLocaleString('fr-FR');
  }

  function renderEmpty() {
    document.querySelector('#invoice-table tbody').innerHTML = '<tr><td colspan="4" class="text-center">Panier vide</td></tr>';
    document.getElementById('subtotal-val').textContent = '0.00';
    document.getElementById('delivery-val').textContent = '0.00';
    document.getElementById('total-val').textContent = '0.00';
    document.getElementById('order-id').textContent = '—';
    document.getElementById('order-date').textContent = '—';
  }

  // When page loads
  document.addEventListener('DOMContentLoaded', () => {
    // if admin toggled online payment in localStorage, enable/disable option
    const onlineEnabled = window.CartAPI.isOnlinePaymentEnabled();
    if (!onlineEnabled) {
      const opt = document.querySelector('#payment-method option[value="enligne"]');
      if (opt) { opt.disabled = true; opt.textContent = opt.textContent + ' (indisponible)'; }
      document.getElementById('payment-note').textContent = 'Paiement en ligne : indisponible (admin).';
    } else {
      document.getElementById('payment-note').textContent = 'Paiement en ligne : disponible.';
    }

    // pre-fill client code input with last value
    const stored = localStorage.getItem('clientCode_current');
    if (stored) document.getElementById('clientCodeInput').value = stored;

    // initial render
    renderInvoice();
    // also ensure cart UI and stock UI updated on this page
    window.CartAPI.updateCartUI();
    window.CartAPI.updateStockUI();
  });

  // events
  document.getElementById('btn-download').addEventListener('click', () => {
    const client = getActiveClientCode();
    if (!client) { alert('Entrez votre code client avant de télécharger la facture.'); return; }
    const paymentMethod = document.getElementById('payment-method').value;
    window.CartAPI.downloadInvoicePDF(client, paymentMethod);
  });

  document.getElementById('btn-clear').addEventListener('click', () => {
    const client = getActiveClientCode();
    if (!client) { alert('Entrez votre code client.'); return; }
    if (confirm('Vider le panier et rendre le stock ?')) {
      window.CartAPI.clearCartForClient(client);
      renderInvoice();
    }
  });

  document.getElementById('btn-call').addEventListener('click', () => { window.location.href = 'tel:5141234567'; });

  // Re-render invoice when payment method or client field changes
  document.getElementById('payment-method').addEventListener('change', renderInvoice);
  document.getElementById('clientCodeInput').addEventListener('input', (e) => {
    localStorage.setItem('clientCode_current', e.target.value.trim());
    renderInvoice();
    window.CartAPI.updateCartUI();
  });

</script>
</body>
</html>
