<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Facture - √âpicerie Sociale</title>
  
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Stripe -->
  <script src="https://js.stripe.com/v3/"></script>

  <style>
    .invoice-header {
      background: linear-gradient(90deg, #007bff, #28a745);
      color: white;
      padding: 20px;
      border-radius: 10px 10px 0 0;
    }
    .payment-status {
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .payment-available {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .payment-unavailable {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
</head>
<body class="bg-light">

<div class="container my-4">
  <div class="invoice-header text-center">
    <h2>Facture - √âpicerie Sociale</h2>
    <p class="mb-0">Carrefour des Initiatives √âducatives et Entrepreneuriales</p>
  </div>

  <div class="bg-white p-4 rounded-bottom shadow">
    <div id="invoice-content">
      <!-- Le contenu de la facture sera g√©n√©r√© ici -->
    </div>
  </div>
</div>

<footer class="text-center p-3 mt-4">
  <p>&copy; 2025 Carrefour des Initiatives √âducatives et Entrepreneuriales</p>
  <div class="mt-3">
    <p>üåê Retrouvez-nous aussi sur :
      <a href="https://facebook.com/toncompte" target="_blank" class="mx-1"><i class="fab fa-facebook fa-lg"></i></a>
      <a href="https://instagram.com/toncompte" target="_blank" class="mx-1"><i class="fab fa-instagram fa-lg"></i></a>
    </p>
  </div>
</footer>

<script>
// Configuration
const STRIPE_PUBLIC_KEY = "pk_test_51QN7qgK4i4q9v5V9L8w5Zx8Yq9v5V9L8w5Zx8Yq9v5V9L8w5Zx8Yq9v5V9L";
let stripeAvailable = true; // ‚ö†Ô∏è Change en false si Stripe est d√©sactiv√©

// Charger le panier
function loadCart() {
  const clientCode = localStorage.getItem('clientCode') || 'N/A';
  return JSON.parse(localStorage.getItem(clientCode)) || [];
}

// G√©n√©rer la facture
function generateInvoice() {
  const cart = loadCart();
  const clientCode = localStorage.getItem('clientCode') || 'N/A';
  const orderNumber = 'CMD-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
  const orderDate = new Date().toLocaleString('fr-FR');
  
  let subtotal = 0;
  let itemsHTML = '';
  
  cart.forEach(item => {
    const itemTotal = item.price * item.qty;
    subtotal += itemTotal;
    itemsHTML += `
      <tr>
        <td>${item.name}</td>
        <td class="text-center">${item.qty}</td>
        <td class="text-end">${item.price.toFixed(2)} $</td>
        <td class="text-end">${itemTotal.toFixed(2)} $</td>
        <td class="text-center">
          <button class="btn btn-sm btn-outline-danger" onclick="removeItem(${item.id})">
            ‚ùå
          </button>
        </td>
      </tr>
    `;
  });
  
  const shipping = subtotal >= 20 ? 0 : 5;
  const total = subtotal + shipping;

  const paymentInstructions = stripeAvailable 
    ? '<div class="payment-available text-center" role="alert"><i class="fas fa-check-circle"></i> Paiement en ligne disponible (Visa, Mastercard, D√©bit).</div>'
    : '<div class="payment-unavailable text-center" role="alert"><i class="fas fa-exclamation-triangle"></i> Paiement en ligne indisponible.<br>üí≥ Paiement accept√© uniquement <strong>au magasin</strong> ou <strong>√† la livraison (liquide ou carte D√©bit)</strong>.</div>';
  
  const invoiceHTML = `
    <div class="invoice-info mb-4 p-3 border rounded">
      <div class="row">
        <div class="col-md-4">
          <p><strong>N¬∞ Commande:</strong><br>${orderNumber}</p>
        </div>
        <div class="col-md-4">
          <p><strong>Code Client:</strong><br>${clientCode}</p>
        </div>
        <div class="col-md-4">
          <p><strong>Date:</strong><br>${orderDate}</p>
        </div>
      </div>
    </div>

    <h5>D√©tails des articles</h5>
    <div class="table-responsive">
      <table class="table table-striped">
        <thead>
          <tr>
            <th>Article</th>
            <th class="text-center">Quantit√©</th>
            <th class="text-end">Prix unitaire</th>
            <th class="text-end">Total</th>
            <th class="text-center">Action</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
        </tbody>
        <tfoot class="table-group-divider">
          <tr>
            <td colspan="3" class="text-end"><strong>Sous-total:</strong></td>
            <td class="text-end">${subtotal.toFixed(2)} $</td>
            <td></td>
          </tr>
          <tr>
            <td colspan="3" class="text-end"><strong>Frais livraison:</strong></td>
            <td class="text-end">${shipping.toFixed(2)} $</td>
            <td></td>
          </tr>
          <tr class="table-active">
            <td colspan="3" class="text-end"><strong>Total:</strong></td>
            <td class="text-end"><strong>${total.toFixed(2)} $</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div id="payment-instructions" class="payment-status">
      ${paymentInstructions}
    </div>

    <div class="text-center mt-4">
      <button class="btn btn-warning btn-sm mx-1 mb-2" onclick="clearCart()">
        üóëÔ∏è Vider le panier
      </button>
      <button class="btn btn-secondary btn-sm mx-1 mb-2" onclick="downloadInvoice('${clientCode}', '${orderNumber}', ${subtotal}, ${shipping}, ${total})">
        üìÑ T√©l√©charger facture
      </button>
      <button class="btn btn-success btn-sm mx-1 mb-2" onclick="processPayment()" ${!stripeAvailable ? 'disabled' : ''}>
        üí≥ Payer en ligne
      </button>
      <button class="btn btn-info btn-sm mx-1 mb-2" onclick="window.location.href='tel:5141234567'">
        üìû Appeler
      </button>
    </div>
  `;
  
  document.getElementById('invoice-content').innerHTML = invoiceHTML;
}

// T√©l√©charger la facture (TXT simple)
function downloadInvoice(clientCode, orderNumber, subtotal, shipping, total) {
  const cart = loadCart();
  const orderDate = new Date().toLocaleString('fr-FR');
  
  let invoiceContent = `FACTURE - √âpicerie Sociale
===========================

Num√©ro de commande: ${orderNumber}
Code client: ${clientCode}
Date: ${orderDate}

ARTICLES COMMAND√âS:
-------------------`;

  cart.forEach(item => {
    const itemTotal = item.price * item.qty;
    invoiceContent += `\n- ${item.name} x${item.qty} = ${itemTotal.toFixed(2)} $`;
  });

  invoiceContent += `

SOUS-TOTAL: ${subtotal.toFixed(2)} $
FRAIS DE LIVRAISON: ${shipping.toFixed(2)} $
TOTAL: ${total.toFixed(2)} $

${stripeAvailable ? 
  'INSTRUCTIONS: Paiement en ligne disponible (Visa, Mastercard, D√©bit).' : 
  'INSTRUCTIONS: Paiement au magasin ou √† la livraison (liquide ou carte D√©bit).'
}

Merci pour votre commande !`;

  const blob = new Blob([invoiceContent], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `facture-${orderNumber}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Traiter le paiement avec Stripe
async function processPayment() {
  if (!stripeAvailable) {
    alert("Paiement en ligne indisponible. Veuillez utiliser le paiement hors ligne.");
    return;
  }

  const cart = loadCart();
  const clientCode = localStorage.getItem('clientCode') || 'N/A';
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
  const shipping = subtotal >= 20 ? 0 : 5;

  try {
    const stripe = Stripe(STRIPE_PUBLIC_KEY);
    
    const response = await fetch('/create-checkout-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        clientCode: clientCode,
        cart: cart,
        delivery_fee: shipping
      })
    });

    const data = await response.json();
    if (data.id) {
      stripe.redirectToCheckout({ sessionId: data.id });
    } else {
      alert("Erreur de paiement: " + data.error);
    }
  } catch (error) {
    alert("Erreur de connexion. Veuillez r√©essayer.");
  }
}

// Supprimer un article
function removeItem(id) {
  const clientCode = localStorage.getItem('clientCode') || 'N/A';
  let cart = loadCart().filter(item => item.id !== id);
  localStorage.setItem(clientCode, JSON.stringify(cart));
  generateInvoice();
}

// Vider le panier
function clearCart() {
  if (confirm("√ätes-vous s√ªr de vouloir vider votre panier ?")) {
    const clientCode = localStorage.getItem('clientCode') || 'N/A';
    localStorage.removeItem(clientCode);
    generateInvoice();
  }
}

// Initialisation
document.addEventListener('DOMContentLoaded', generateInvoice);
</script>
</body>
</html>
