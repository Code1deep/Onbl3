<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>√âpicerie Sociale - Fruits & L√©gumes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background: #f9f9f9; font-family: 'Arial', sans-serif; }
    header { background: linear-gradient(90deg, #007bff, #28a745); color: white; padding: 15px; text-align: center; }
    .logo { height: 60px; margin-right: 10px; }
    .product-card { background: white; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .product-card:hover { transform: translateY(-5px); }
    .cart { position: fixed; top: 20px; right: 20px; background: #007bff; color: white; padding: 10px 15px; border-radius: 50px; cursor: pointer; z-index: 999; }
    .cart-count { background: red; color: white; font-size: 12px; padding: 2px 6px; border-radius: 50%; position: absolute; top: -5px; right: -5px; }
    .cart-modal { display: none; position: fixed; top: 80px; right: 20px; width: 380px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); padding: 15px; z-index: 1000; }
    .btn-animate { transition: transform 0.2s; }
    .btn-animate:active { transform: scale(0.95); }
    .alert-admin { background: #ffdddd; border: 1px solid #ff8888; color: #990000; padding: 10px; text-align: center; font-weight: bold; display: none; }
  </style>
</head>
<body>
<header>
  <img src="assets/logo_fr.png" class="logo" alt="Logo">
  <h1>Fruits et L√©gumes Solidaires</h1>
  <p>Produits frais √† prix solidaires ‚Äì Livraison gratuite d√®s 20$</p>
</header>

<!-- Bandeau admin paiement en ligne -->
<div id="admin-alert" class="alert-admin">‚ö†Ô∏è Paiement en ligne temporairement indisponible. Paiement possible au magasin ou √† la livraison.</div>

<!-- Section admin -->
<div class="text-center my-2">
  <button class="btn btn-sm btn-outline-danger" onclick="togglePayment()">‚öôÔ∏è Activer/D√©sactiver paiement en ligne</button>
</div>

<div class="container my-3">
  <a href="page2.html">‚Üí Page suivante</a> | <a href="page1.html">‚Üê Page pr√©c√©dente</a>
  <nav class="text-center my-3">
    <a href="fruits_legumes.html" class="btn btn-outline-success mx-1">Fruits & L√©gumes</a>
    <a href="produits_sec.html" class="btn btn-outline-primary mx-1">Produits Secs</a>
    <a href="hygiene_products.html" class="btn btn-outline-danger mx-1">Hygi√®ne</a>
    <a href="facture.html" class="btn btn-dark mx-1">Voir Facture</a>
  </nav>
  <div class="row">
    <div class="col-md-6">
      <label for="clientCode"><strong>Code client :</strong></label>
      <input type="text" id="clientCode" class="form-control" placeholder="Entrez votre code client">
    </div>
    <div class="col-md-6">
      <label for="filter"><strong>Trier par :</strong></label>
      <select id="filter" class="form-control" onchange="filterProducts()">
        <option value="all">Tous les produits</option>
        <option value="vedette">Produits vedettes</option>
        <option value="nouveau">Nouveaux</option>
        <option value="top">Les plus vendus</option>
      </select>
    </div>
  </div>
</div>

<div class="container my-4">
  <div class="row" id="product-list"></div>
</div>

<!-- Ic√¥ne Panier -->
<div class="cart" onclick="toggleCart()">
  <i class="fa fa-shopping-cart"></i>
  <span class="cart-count" id="cart-count">0</span>
</div>

<!-- Panier -->
<div class="cart-modal" id="cart-modal">
  <h5>Votre Panier</h5>
  <div id="cart-items"></div>
  <hr>
  <p>Sous-total: <span id="subtotal">0.00</span>$</p>
  <p>Frais livraison: <span id="shipping">0.00</span>$</p>
  <p><strong>Total: <span id="total">0.00</span>$</strong></p>
  <p id="free-shipping-msg" style="color:green; display:none;">Livraison gratuite !</p>
  <button class="btn btn-warning w-100 mb-2" onclick="clearCart()">üóëÔ∏è Vider le panier</button>
  <button class="btn btn-success w-100 mb-2" onclick="proceedPayment()">Paiement en ligne</button>
  <button class="btn btn-primary w-100 mb-2" onclick="viewDetailedInvoice()"> üìã Voir la facture d√©taill√©e</button>
  <button class="btn btn-secondary w-100" onclick="callOrder()">Ou appeler: 514-123-4567</button>
</div>

<script>
// --- PRODUITS ---
let products = [
  {id:1, name:'Pommes (1 kg)', price:2.5, img:'assets/fruits/pommes.jpg', tag:'vedette', stock:10},
  {id:2, name:'Carottes (1 kg)', price:1.8, img:'assets/fruits/carottes.jpg', tag:'nouveau', stock:15},
  {id:3, name:'Oranges (1 kg)', price:3.0, img:'assets/fruits/oranges.jpg', tag:'top', stock:12}
];
let cart = [];
let stripeAvailable = true;

// --- ADMIN : activer/d√©sactiver paiement en ligne ---
function togglePayment() {
  stripeAvailable = !stripeAvailable;
  document.getElementById('admin-alert').style.display = stripeAvailable ? 'none' : 'block';
}

// --- AFFICHAGE PRODUITS ---
function renderProducts(list=products){
  const container=document.getElementById('product-list');
  container.innerHTML='';
  list.forEach(p=>{
    container.innerHTML+=`
      <div class="col-md-4 mb-4">
        <div class="product-card p-3">
          <img src="${p.img}" class="img-fluid rounded mb-2">
          <h5>${p.name}</h5>
          <p><strong>${p.price.toFixed(2)} $</strong></p>
          <p><em>Stock restant: ${p.stock}</em></p>
          <input type="number" min="1" max="${p.stock}" value="1" id="qty-${p.id}" class="form-control mb-2">
          <button class="btn btn-primary w-100 btn-animate" onclick="addToCart(${p.id})" ${p.stock<=0 ? 'disabled' : ''}>
            <i class="fa fa-cart-plus"></i> Ajouter au panier
          </button>
        </div>
      </div>`;
  });
}

function filterProducts(){
  const val=document.getElementById('filter').value;
  let filtered=products;
  if(val!=='all') filtered=products.filter(p=>p.tag===val);
  renderProducts(filtered);
}

// --- PANIER ---
function addToCart(id){
  const clientCode=document.getElementById('clientCode').value;
  if(!clientCode){alert("Veuillez entrer votre code client");return;}
  cart=JSON.parse(localStorage.getItem(clientCode)||'[]');
  const qty=parseInt(document.getElementById('qty-'+id).value);
  const product=products.find(p=>p.id===id);

  if(product.stock<qty){ alert("Stock insuffisant."); return; }
  product.stock-=qty; // d√©cr√©menter stock

  const item=cart.find(i=>i.id===id);
  if(item){ item.qty+=qty; }
  else { cart.push({...product, qty:qty}); }

  localStorage.setItem(clientCode,JSON.stringify(cart));
  renderProducts();
  updateCart(clientCode);
}

function removeItem(id){
  const clientCode=document.getElementById('clientCode').value;
  const item=cart.find(i=>i.id===id);
  if(item){ // remettre stock
    const product=products.find(p=>p.id===id);
    product.stock+=item.qty;
  }
  cart=cart.filter(i=>i.id!==id);
  localStorage.setItem(clientCode,JSON.stringify(cart));
  renderProducts();
  updateCart(clientCode);
}

function clearCart(){
  const clientCode=document.getElementById('clientCode').value;
  cart.forEach(item=>{
    const product=products.find(p=>p.id===item.id);
    product.stock+=item.qty; // remettre stock
  });
  localStorage.removeItem(clientCode);
  renderProducts();
  updateCart(clientCode);
}

function updateCart(clientCode){
  cart=JSON.parse(localStorage.getItem(clientCode)||'[]');
  document.getElementById('cart-count').innerText=cart.reduce((s,i)=>s+i.qty,0);
  let subtotal=0;
  const cartItems=document.getElementById('cart-items');
  cartItems.innerHTML='';
  cart.forEach(item=>{
    subtotal+=item.price*item.qty;
    cartItems.innerHTML+=`<p>${item.name} x${item.qty} = ${(item.price*item.qty).toFixed(2)}$ 
      <button onclick="removeItem(${item.id})" class="btn btn-sm btn-danger">‚ùå</button></p>`;
  });
  let shipping=subtotal>20?0:5;
  document.getElementById('free-shipping-msg').style.display=shipping===0?'block':'none';
  document.getElementById('subtotal').innerText=subtotal.toFixed(2);
  document.getElementById('shipping').innerText=shipping.toFixed(2);
  document.getElementById('total').innerText=(subtotal+shipping).toFixed(2);
}

function toggleCart(){
  const modal=document.getElementById('cart-modal');
  modal.style.display=modal.style.display==='block'?'none':'block';
  const clientCode=document.getElementById('clientCode').value;
  if(clientCode) updateCart(clientCode);
}

// --- FACTURE ---
function viewDetailedInvoice(){
  const clientCode=document.getElementById('clientCode').value;
  cart=JSON.parse(localStorage.getItem(clientCode)||'[]');
  if(cart.length===0){alert("Votre panier est vide.");return;}
  const orderNumber = 'CMD-' + Math.floor(Math.random() * 100000);
  const orderDate = new Date().toLocaleString('fr-FR');
  let invoiceHTML = `
    <div class="invoice-details mb-3 p-3 border rounded">
      <h4>üìã Facture D√©taill√©e</h4>
      <p><strong>N¬∞ Commande:</strong> ${orderNumber}</p>
      <p><strong>Code Client:</strong> ${clientCode}</p>
      <p><strong>Date:</strong> ${orderDate}</p>
      <table class="table table-sm mt-3">
        <thead class="table-light">
          <tr><th>Article</th><th>Qt√©</th><th>Prix</th><th>Total</th></tr>
        </thead><tbody>`;
  let subtotal=0;
  cart.forEach(item=>{
    const itemTotal=item.price*item.qty;
    subtotal+=itemTotal;
    invoiceHTML+=`<tr><td>${item.name}</td><td>${item.qty}</td>
    <td>${item.price.toFixed(2)} $</td><td>${itemTotal.toFixed(2)} $</td></tr>`;
  });
  const shipping=subtotal>20?0:5;
  const total=subtotal+shipping;
  invoiceHTML+=`</tbody><tfoot>
    <tr><td colspan="3">Sous-total</td><td>${subtotal.toFixed(2)} $</td></tr>
    <tr><td colspan="3">Livraison</td><td>${shipping.toFixed(2)} $</td></tr>
    <tr><td colspan="3"><strong>Total</strong></td><td><strong>${total.toFixed(2)} $</strong></td></tr>
  </tfoot></table>
  <button class="btn btn-outline-secondary w-100 mt-2" onclick="window.location.reload()">‚Ü©Ô∏è Retour au magasin</button>
  </div>`;
  document.getElementById('cart-items').innerHTML=invoiceHTML;
}

function callOrder(){window.location.href='tel:5141234567';}

// --- INIT ---
renderProducts();
</script>
<script>
// --- PATCH: remplacer le lien facture.html par "Afficher le panier" et am√©liorer les fonctions facture/paiment/pdf --- 
(function () {
  // s'assurer que fonctions existantes (toggleCart, updateCart etc.) restent accessibles
  document.addEventListener('DOMContentLoaded', () => {
    // 1) Remplacer tout lien vers facture.html par un bouton "Afficher le panier"
    const factLinks = Array.from(document.querySelectorAll('a[href*="facture"]'));
    factLinks.forEach(a => {
      // changer libell√© et comportement
      a.textContent = 'Afficher le panier';
      a.removeAttribute('href');
      a.style.cursor = 'pointer';
      a.onclick = (e) => { e.preventDefault(); if (typeof toggleCart === 'function') toggleCart(); };
    });

    // 2) Charger libs jsPDF + autotable si besoin (retourne Promise)
    function loadScriptOnce(src) {
      return new Promise((resolve, reject) => {
        if (document.querySelector('script[src="' + src + '"]')) return resolve();
        const s = document.createElement('script');
        s.src = src;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Erreur chargement ' + src));
        document.head.appendChild(s);
      });
    }

    // 3) Nouvelle impl√©mentation de download PDF (utilise jsPDF + autotable)
    async function downloadInvoicePDF(orderNumber, clientCode, cartItems) {
      try {
        await loadScriptOnce('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        await loadScriptOnce('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'pt', format: 'a4' });

        // Header
        doc.setFontSize(14);
        doc.text('Carrefour des Initiatives - √âpicerie Sociale', 40, 40);
        doc.setFontSize(11);
        doc.text(`Facture N¬∞: ${orderNumber}`, 40, 60);
        doc.text(`Code client: ${clientCode}`, 40, 76);
        doc.text(`Date: ${new Date().toLocaleString('fr-FR')}`, 40, 92);

        // Table body
        const body = cartItems.map(i => {
          const total = (i.qty || i.quantity || i.qty === 0 ? i.qty : i.quantity) * i.price;
          return [i.name || i.title || '', (i.qty || i.quantity || 0).toString(), i.price.toFixed(2) + ' $', total.toFixed(2) + ' $'];
        });

        doc.autoTable({
          head: [['Article', 'Quantit√©', 'Prix unitaire', 'Total']],
          body,
          startY: 120,
          margin: { left: 40, right: 40 }
        });

        // Totals
        const subtotal = cartItems.reduce((s,i) => s + ( (i.qty||i.quantity||0) * i.price ), 0);
        const shipping = subtotal > 20 ? 0 : 5;
        const total = subtotal + shipping;
        const finalY = doc.lastAutoTable ? doc.lastAutoTable.finalY + 20 : 200;

        doc.text(`Sous-total: ${subtotal.toFixed(2)} $`, 350, finalY);
        doc.text(`Frais livraison: ${shipping.toFixed(2)} $`, 350, finalY + 16);
        doc.setFontSize(12);
        doc.text(`TOTAL: ${total.toFixed(2)} $`, 350, finalY + 36);

        // Footer / Instructions
        doc.setFontSize(10);
        doc.text("Modes de paiement: En ligne (Visa/Mastercard) ou paiement au magasin/√† la livraison (liquide ou d√©bit).", 40, finalY + 70);
        doc.save(`facture_${orderNumber}.pdf`);
      } catch (err) {
        alert('Erreur g√©n√©ration PDF: ' + (err.message || err));
        console.error(err);
      }
    }

    // 4) Nouvelle viewDetailedInvoice() : remplace/compl√®te l'ancienne
    window.viewDetailedInvoice = function () {
      const clientCode = (document.getElementById('clientCode') || {}).value || localStorage.getItem('clientCode') || '';
      if (!clientCode) { alert('Veuillez entrer votre code client.'); return; }
      const cart = JSON.parse(localStorage.getItem(clientCode) || '[]');
      if (!cart || cart.length === 0) { alert('Votre panier est vide.'); return; }

      const orderNumber = 'CMD-' + Date.now();
      const orderDate = new Date().toLocaleString('fr-FR');

      // calculs
      const subtotal = cart.reduce((s,i) => s + ((i.qty||i.quantity||0) * i.price), 0);
      const shipping = subtotal > 20 ? 0 : 5;
      const total = subtotal + shipping;

      // construire HTML facture (inject√©e dans #cart-items)
      let html = `<div class="invoice-details mb-3 p-3 border rounded">
        <h4>üìã Facture D√©taill√©e</h4>
        <p><strong>N¬∞ Commande:</strong> ${orderNumber}</p>
        <p><strong>Code Client:</strong> ${clientCode}</p>
        <p><strong>Date:</strong> ${orderDate}</p>

        <div class="table-responsive"><table class="table table-sm">
          <thead><tr><th>Article</th><th>Qt√©</th><th>Prix</th><th>Total</th></tr></thead><tbody>`;

      cart.forEach(i => {
        const qty = i.qty || i.quantity || 0;
        const lineTotal = (qty * i.price).toFixed(2);
        html += `<tr><td>${i.name}</td><td>${qty}</td><td class="text-end">${i.price.toFixed(2)} $</td><td class="text-end">${lineTotal} $</td></tr>`;
      });

      html += `</tbody>
        <tfoot>
          <tr><td colspan="3" class="text-end"><strong>Sous-total:</strong></td><td class="text-end">${subtotal.toFixed(2)} $</td></tr>
          <tr><td colspan="3" class="text-end"><strong>Frais livraison:</strong></td><td class="text-end">${shipping.toFixed(2)} $</td></tr>
          <tr class="table-active"><td colspan="3" class="text-end"><strong>Total:</strong></td><td class="text-end"><strong>${total.toFixed(2)} $</strong></td></tr>
        </tfoot>
        </table></div>`;

      // payment method selection
      const stripeEnabled = (typeof stripeAvailable !== 'undefined') ? !!stripeAvailable : false;
      html += `<div class="mb-2"><label><strong>Mode de paiement :</strong></label>
        <select id="invoice-payment-method" class="form-control">
          <option value="pickup">Paiement au magasin</option>
          <option value="delivery">Paiement √† la livraison</option>`;
      if (stripeEnabled) html += `<option value="online">Paiement en ligne (carte)</option>`;
      html += `</select></div>`;

      // action buttons: payer, t√©l√©charger, fermer/retour
      html += `<div class="d-grid gap-2">
        <button class="btn btn-success" id="invoice-pay-btn">üí≥ Payer / Finaliser</button>
        <button class="btn btn-secondary" id="invoice-download-btn">üìÑ T√©l√©charger en PDF</button>
        <button class="btn btn-outline-dark" id="invoice-close-btn">‚úñÔ∏è Fermer</button>
        <button class="btn btn-outline-primary" id="invoice-return-shop">‚Ü©Ô∏è Retour au magasin</button>
      </div>
      </div>`;

      document.getElementById('cart-items').innerHTML = html;

      // lier √©v√©nements
      document.getElementById('invoice-download-btn').onclick = () => {
        downloadInvoicePDF(orderNumber, clientCode, cart);
      };
      document.getElementById('invoice-close-btn').onclick = () => {
        // fermer le modal panier (si toggleCart disponible)
        if (typeof toggleCart === 'function') toggleCart();
        // sinon vider l'affichage
        else document.getElementById('cart-items').innerHTML = '';
      };
      document.getElementById('invoice-return-shop').onclick = () => {
        // simplement recharger la page pour continuer les achats
        window.location.reload();
      };
      document.getElementById('invoice-pay-btn').onclick = async () => {
        const method = (document.getElementById('invoice-payment-method') || {}).value || 'pickup';
        // si en ligne demand√© mais non disponible
        if (method === 'online' && !stripeEnabled) {
          alert('Paiement en ligne temporairement indisponible. Choisissez paiement au magasin ou √† la livraison.');
          return;
        }
        // si paiement en ligne et stripeAvailable: tenter redirection (serveur requis)
        if (method === 'online') {
          // essayer de rediriger vers endpoint create-checkout-session
          try {
            const res = await fetch('/create-checkout-session', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({clientCode, cart, orderNumber})
            });
            const data = await res.json();
            if (data && data.url) {
              window.location = data.url;
              return;
            } else {
              alert('Impossible de d√©marrer Stripe Checkout (r√©ponse serveur manquante).');
            }
          } catch (err) {
            console.error(err);
            alert('Erreur de connexion au serveur Stripe. Essayez plus tard ou choisissez paiement au magasin.');
            return;
          }
        }

        // Pour paiement hors-ligne: g√©n√©rer PDF et fermer modal
        await downloadInvoicePDF(orderNumber, clientCode, cart);
        alert('Facture g√©n√©r√©e. Merci ‚Äî pr√©sentez la facture au magasin ou payez √† la livraison.');
        // vider panier local pour marquer commande termin√©e (optionnel) : commenter si on veut conserver
        // localStorage.removeItem(clientCode);
        if (typeof toggleCart === 'function') toggleCart();
      };
    };

    // 5) Remplacer la vieille proceedPayment() si appel√©e ailleurs : 
    window.proceedPayment = function () {
      // si la facture est affich√©e, simuler clic sur payer, sinon ouvrir la facture
      const paySelect = document.getElementById('invoice-payment-method');
      if (paySelect && document.getElementById('invoice-pay-btn')) {
        document.getElementById('invoice-pay-btn').click();
        return;
      }
      // sinon afficher la facture d√©taill√©e
      if (typeof viewDetailedInvoice === 'function') viewDetailedInvoice();
      else alert('Affichage facture indisponible.');
    };

    // 6) Si un bouton existant (secondaire) "Voir la facture" est mal configur√©, on remplace son action par "Afficher panier" :
    const secondaryBtns = Array.from(document.querySelectorAll('button, a'));
    secondaryBtns.forEach(el => {
      const text = (el.textContent || '').trim().toLowerCase();
      if (text === 'voir facture' || text === 'voir la facture' || text === 'voir la facture d√©taill√©e') {
        // remplace action pour afficher le panier/facture
        el.onclick = (e) => { e.preventDefault(); if (typeof toggleCart === 'function') toggleCart(); };
      }
    });

    // 7) Mettre √† jour compteur/cart display (si updateCartUI existe)
    if (typeof updateCartUI === 'function') updateCartUI();
  });
})();
</script>
</body>
</html>
