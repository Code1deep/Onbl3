<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Fruits & Légumes - ONBL</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background:#f9f9f9; font-family: Arial, sans-serif; }
    header{ background:linear-gradient(90deg,#007bff,#28a745); color:#fff; padding:20px; text-align:center; }
    .product-card{ background:#fff; border-radius:10px; padding:15px; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
    .cart{ position:fixed; top:18px; right:18px; z-index:999; }
  </style>
</head>
<body>

<header>
  <img src="assets/logo_fr.png" alt="Logo" style="height:56px;">
  <h1>Fruits et Légumes Solidaires</h1>
  <p>Livraison gratuite dès 20$</p>
</header>

<div class="container my-3">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <a href="fruits_legumes.html" class="btn btn-outline-success btn-sm">Fruits & Légumes</a>
      <a href="produits_sec.html" class="btn btn-outline-primary btn-sm">Produits Secs</a>
      <a href="hygiene_products.html" class="btn btn-outline-danger btn-sm">Hygiène</a>
    </div>
    <div>
      <input id="clientCode" class="form-control form-control-sm" style="display:inline-block; width:200px;" placeholder="Code client (ex: 123)" 
             oninput="localStorage.setItem('clientCode_current', this.value.trim()); window.CartAPI.updateCartUI();" />
      <a href="facture.html" class="btn btn-dark btn-sm ms-2">Voir facture</a>
    </div>
  </div>

  <div id="product-list" class="row gy-3"></div>

  <hr>
  <p>Page navigation: <a href="page2.html">Page 2</a> | <a href="page3.html">Page 3</a></p>
</div>

<!-- Floating cart summary (simple) -->
<div class="cart">
  <div class="card" style="width:280px;">
    <div class="card-body">
      <h6 class="card-title"><i class="fa fa-shopping-cart"></i> Votre Panier (<span id="cart-count">0</span>)</h6>
      <div id="cart-items" style="max-height:260px; overflow:auto;"></div>
      <hr>
      <p>Sous-total: <strong><span id="subtotal">0.00</span>$</strong></p>
      <p>Livraison: <strong><span id="shipping">0.00</span>$</strong></p>
      <p>Total: <strong><span id="total">0.00</span>$</strong></p>
      <button class="btn btn-warning w-100 mb-1" onclick="clearCartAction()">Vider le panier</button>
      <button class="btn btn-success w-100 mb-1" onclick="proceedPaymentAction()">Paiement / Terminer</button>
      <a href="facture.html" class="btn btn-primary w-100">Voir facture détaillée</a>
    </div>
  </div>
</div>

<!-- libs -->
<script src="cart.js"></script>

<script>
  // Product data for this page (id must match stock keys)
  const products = [
    { id: 1, name: "Pommes (1 kg)", price: 2.50, img: "assets/fruits/pommes.jpg", tag: "vedette" },
    { id: 2, name: "Carottes (1 kg)", price: 1.80, img: "assets/fruits/carottes.jpg", tag: "nouveau" },
    { id: 3, name: "Oranges (1 kg)", price: 3.00, img: "assets/fruits/oranges.jpg", tag: "top" }
  ];

  // Initialize stock only once (if stock empty)
  // keys correspond to product ids
  window.CartAPI.initStock({ "1": 10, "2": 15, "3": 12 });

  function renderProducts(filter='all') {
    const list = document.getElementById('product-list');
    list.innerHTML = '';
    const stock = window.CartAPI.loadStock();
    products.forEach(p => {
      const col = document.createElement('div');
      col.className = 'col-md-4';
      col.innerHTML = `
        <div class="product-card">
          <img src="${p.img}" alt="${p.name}" style="width:100%; height:160px; object-fit:cover; border-radius:6px;">
          <h5 class="mt-2">${p.name}</h5>
          <p><strong>${p.price.toFixed(2)} $</strong></p>
          <p id="stock-${p.id}">Stock restant: ${stock[p.id] ?? 0}</p>
          <div class="input-group mb-2" style="max-width:140px;">
            <input type="number" id="qty-${p.id}" class="form-control form-control-sm" min="1" value="1">
            <button class="btn btn-sm btn-primary" onclick="onAdd(${p.id})"><i class="fa fa-cart-plus"></i></button>
          </div>
        </div>
      `;
      list.appendChild(col);
    });
    // update UI counts after render
    window.CartAPI.updateCartUI();
    window.CartAPI.updateStockUI();
  }

  function onAdd(id) {
    const qty = Number(document.getElementById(`qty-${id}`).value) || 1;
    const clientCode = (document.getElementById('clientCode').value || '').trim();
    if (!clientCode) { alert('Veuillez entrer votre code client avant d\'ajouter'); return; }
    const prod = products.find(p => p.id === id);
    window.CartAPI.addToCartObj(clientCode, { id: prod.id, name: prod.name, price: prod.price, quantity: qty });
  }

  function clearCartAction() {
    const client = (document.getElementById('clientCode').value || '').trim();
    if (!client) { alert('Entrez code client'); return; }
    if (confirm('Vider le panier ?')) window.CartAPI.clearCartForClient(client);
  }

  function proceedPaymentAction() {
    const client = (document.getElementById('clientCode').value || '').trim();
    if (!client) { alert('Entrez code client'); return; }
    // if online payment is enabled, redirect to checkout (not implemented backend)
    if (window.CartAPI.isOnlinePaymentEnabled()) {
      alert('Paiement en ligne activé — rediriger vers Checkout (à implémenter côté serveur).');
      // Here you would call your backend to create a Stripe session.
    } else {
      // Show invoice in the cart area (offline)
      const inv = window.CartAPI.generateInvoiceHTML(client, 'Au magasin / Livraison');
      if (inv) document.getElementById('cart-items').innerHTML = inv.html;
    }
  }

  // set remembered clientCode input from localStorage if present
  document.addEventListener('DOMContentLoaded', () => {
    const stored = localStorage.getItem('clientCode_current');
    if (stored) document.getElementById('clientCode').value = stored;
    renderProducts();
  });

</script>
</body>
</html>
